<% include layout/platform.html %>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>ADMIN</title>
    <link href="lib/sb-admin-2/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="lib/sb-admin-2/vendor/metisMenu/metisMenu.min.css" rel="stylesheet">
    <link href="lib/sb-admin-2/dist/css/sb-admin-2.css" rel="stylesheet">
    <link href="lib/sb-admin-2/vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <!-- <link rel="stylesheet" href="lib/awesomplete-gh-pages/awesomplete.css"> -->
    <link rel="stylesheet" href="lib/awesomplete-gh-pages/prism/prism.css" />
    <link rel="stylesheet" href="lib/awesomplete-gh-pages/awesomplete.css" />
    <!-- <link rel="stylesheet" href="lib/awesomplete-gh-pages/style.css" /> -->
    <script src="lib/awesomplete-gh-pages/awesomplete.js"></script>
    <!-- <script src="lib/awesomplete-gh-pages/index.js"></script> -->

	<style>
		.table.receta input{
			padding: 3px;
		}
		.breadcrumb li{
            font-size: 16px;
        }
        .input-group-addon{
            cursor: pointer;
        }
        body .panel-body input{
            font-size:18px;
        }
	</style>
    </head>
<body>
    <!-- /#wrapper -->
    <%-menu()%>
    <!-- Page Content -->
    <div id="page-wrapper">
            <br>
            <div class="row">
                <div class="col-lg-12">
                    <div class="row">
		                <div class="col-lg-12">
		                    <ol class="breadcrumb">
		                      <li><a href="#">Receta</a></li>
		                      <li class="active"><%=idr!=0?"Actualizar":"Registrar"%></li>
		                    </ol>
		                </div>
		            </div>    
                </div>
            </div>
            <div class="row" id='search_patient_row'>
                <div class="col-lg-8">
					<div class="custom-search-form" >
                        <input type="text" class="form-control awesomplete" placeholder="Busqueda de Paciente" id='search_patient'
                        style="">
                        <!-- <span class="input-group-btn">
                            <button class="btn btn-default" type="button">
                                <i class="fa fa-search"></i>
                            </button>
                        </span> -->
                    </div>
				</div>
            </div>
            <br>
            <div class="row">
                <div class="col-lg-8">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <%=idr!=0?"Actualización de Receta":"Registro de Receta" %>
                            <!-- <button type='button' class='btn btn-info btn-circle btn-x2'  data-toggle='modal' data-target='#modal_patientRecord' onclick="receta_getlistXpatient(27);" title='Ver historial del paciente'><i class='fa fa-list'></i></button> -->


                        </div>
                        <div class="panel-body">
                            <div class="row">
                                <div class="col-lg-12" align="center">
                                    <span class='button-actions'></span>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-lg-12">
                                    <div class="form-group" id='cod_receta' style='display: none;'>
                                        <label>Cod.Receta</label>
                                        <input class="form-control" id='id_receta' value='<%=idr%>' disabled>
                                    </div>
                                    <div class="form-group">
                                        <label onclick="$('#search_patient').focus();" style="cursor:pointer;">Paciente <span style='color:#4066D3;'>#<span id='id_paciente'><%=idp%></span></span></label>
                                        <input class="form-control" id='fullname' value='<%=fullname%>' disabled>
                                    </div>
                                    <table class='table receta' border="1" style='border:5px #F2F2F2 solid;'>
                                    	<tr>
                                            <td></td>
                                            <th>Esf.</th>
                                    		<td></td>
                                    		<th>Cil.</th>
                                    		<th>Eje.</th>
                                    	</tr>
                                    	<tr>
                                    		<th>OD.</th>
                                            <!-- <td><input type="text" class="form-control" value="" id="esf_od"></td> -->
                                    		<td style="background-color: #EDFFF0;">
                                                <div class="form-group input-group">
                                                    <span class="input-group-addon" style='width: 50px;' onclick="$('#esf_od').val('+'); $('#esf_od').focus();">
                                                        <span style='font-size:17px;'><font color='blue'>+</font></span>
                                                    </span>&nbsp;
                                                    <span class="input-group-addon" style='width: 50px;' onclick="$('#esf_od').val('-'); $('#esf_od').focus();">
                                                        <span style='font-size:17px;'><font color='red'>-</font></span>
                                                    </span>
                                                </div>
                                                    <input data-list="-5.00,-4.75,-4.50,-4.25,-4.00,-3.75,-3.50,-3.25,-3.00,-2.75,-2.50,-2.25,-2.00,-1.75,-1.50,-1.25,-1.00,-1.75,-1.50,-1.25,-1.00,-0.75,-0.50,-0.25,-0.00,+0.00,+0.25,+0.50,+0.75,+1.00,+1.25,+1.50,+1.75,+2.00,+2.25,+2.50,+2.75,+3.00,+3.25,+3.50,+3.75,+4.00,+4.25,+4.50,+4.75,+5.0" class="dropdown-input-esf-od form-control" width='100%' id="esf_od" style='font-size:20px;'/><button class="dropdown-btn-esf-od" type="button"><span class="caret"></span></button>
                                                
                                            </td>
                                            <td></td>
                                            <!-- <td><input type="text" class="form-control" value="" id="cil_od"></td> -->
                                    		<td style="background-color: #E3FFE7;">
                                                <div class="form-group input-group">
                                                    <span class="input-group-addon" style="width: 50px;" onclick="$('#cil_od').val('-');$('#cil_od').focus(); "><span style='font-size:17px;'><font color='red'>-</font></span>
                                                    </span>
                                                </div>
                                                    <input data-list="-5.00,-4.75,-4.50,-4.25,-4.00,-3.75,-3.50,-3.25,-3.00,-2.75,-2.50,-2.25,-2.00,-1.75,-1.50,-1.25,-1.00,-1.75,-1.50,-1.25,-1.00,-0.75,-0.50,-0.25,-0.00" class="dropdown-input-cil-od form-control" id="cil_od" style="width: 100%;" style='font-size:20px;'/><button class="dropdown-btn-cil-od" type="button"><span class="caret"></span></button>
                                            </td>
                                    		<td style="background-color: #E3FFE7;">
                                                <div class="form-group input-group">
                                                    <span class="input-group-addon" style="width: 50px;" onclick="$('#eje_od').focus();"><span style="font-size:17px;"><font color='gray' style='font-size:12px;'>Escala</font></span>
                                                    </span>
                                                </div>
                                                <input type="number" class="form-control" value="" id="eje_od" style='font-size:20px;'>
                                            </td>
                                    	</tr>
                                    	<tr>
                                    		<th>OI.</th>
                                    		<td style="background-color: #F9FEE6;">
                                                <div class="form-group input-group">
                                                    <span class="input-group-addon" style='width: 50px;' onclick="$('#esf_oi').val('+'); $('#esf_oi').focus();">
                                                        <span style='font-size:17px;'><font color='blue'>+</font></span>
                                                    </span>&nbsp;
                                                    <span class="input-group-addon" style='width: 50px;' onclick="$('#esf_oi').val('-'); $('#esf_oi').focus();">
                                                        <span style='font-size:17px;'><font color='red'>-</font></span>
                                                    </span>
                                                </div>
                                                    <input data-list="-5.00,-4.75,-4.50,-4.25,-4.00,-3.75,-3.50,-3.25,-3.00,-2.75,-2.50,-2.25,-2.00,-1.75,-1.50,-1.25,-1.00,-1.75,-1.50,-1.25,-1.00,-0.75,-0.50,-0.25,-0.00,+0.00,+0.25,+0.50,+0.75,+1.00,+1.25,+1.50,+1.75,+2.00,+2.25,+2.50,+2.75,+3.00,+3.25,+3.50,+3.75,+4.00,+4.25,+4.50,+4.75,+5.0" class="dropdown-input-esf-oi form-control" width='100%' id="esf_oi" style='font-size:20px;'/><button class="dropdown-btn-esf-oi" type="button"><span class="caret"></span></button>
                                            </td>
                                            <td>&nbsp;&nbsp;</td>
                                    		<td style="background-color: #F7FFD7;">
                                                <div class="form-group input-group">
                                                    
                                                    <span class="input-group-addon" style='width: 50px;' onclick="$('#cil_oi').val('-'); $('#cil_oi').focus();">
                                                        <span style='font-size:17px;'><font color='red'>-</font></span>
                                                    </span>
                                                </div>
                                                    <input data-list="-5.00,-4.75,-4.50,-4.25,-4.00,-3.75,-3.50,-3.25,-3.00,-2.75,-2.50,-2.25,-2.00,-1.75,-1.50,-1.25,-1.00,-1.75,-1.50,-1.25,-1.00,-0.75,-0.50,-0.25,-0.00" class="dropdown-input-cil-oi form-control" width='100%' id="cil_oi" style='font-size:20px;'/><button class="dropdown-btn-cil-oi" type="button"><span class="caret"></span></button>

                                            </td>
                                    		<td style="background-color: #F7FFD7;">
                                                <div class="form-group input-group">
                                                    <span class="input-group-addon" style="width: 50px;" onclick="$('#eje_oi').focus();"><span style="font-size:17px;"><font color='gray' style='font-size:12px;'>Escala</font></span>
                                                    </span>
                                                </div>
                                            <input type="number" class="form-control" value="" id="eje_oi" style='font-size:20px;'></td>

                                    	</tr>
                                    </table>
                                    <table class='table' border="1" style='border:5px #F2F2F2 solid;'>
                                    	<tr>
                                    		<th>ADD</th>
                                    		<th colspan="2">DIP</th>
                                    		<th colspan="2">EDAD</th>
                                    	</tr>
                                    	<tr>

                                    		<td>
                                                <div class="form-group input-group">
                                                        
                                                        <span class="input-group-addon" style='width: 50px;' onclick="$('#add').val('+'); $('#add').focus();">
                                                            <span style='font-size:12px;'><font color='blue'>+</font></span>
                                                        </span>
                                                    </div>
                                                <input data-list="+0.25,+0.50,+0.75,+1.00,+1.25,+1.50,+1.75,+2.00,+2.25,+2.50,+2.75,+3.00,+3.25,+3.50,+3.75,+4.00,+4.25,+4.50" class="dropdown-input-add form-control" width='100%' id="add" style='font-size:20px;'/><button class="dropdown-btn-add" type="button"><span class="caret"></span></button>
                                                <!-- <input type="text" class="form-control" value="" id="add"> -->
                                            </td>

                                    		<td><br><br><input type="number" class="form-control" value="" id="dip1"></td>
                                    		<td><br><br><input type="number" class="form-control" value="" id="dip2"></td>
                                    		<td><br><br><input type="number" class="form-control" value="" id="edad"></td>
                                    		<th><br><br>años</th>
                                    	</tr>
                                    </table>


                                </div>
                            </div>
							<div class="row">
								<div class="col-lg-2">
                                    <br>
                                    <br>
									<label>Producto: </label>
								</div>
								<div class="col-lg-10">
                                    <div class="form-group input-group">
                                        <span class="input-group-addon" style="width: 50px;" onclick="$('#producto').val('MONOFOCAL ');$('#producto').focus();"><span style="font-size:14px;"><font color='gray'>MONOFOCAL</font></span>
                                        </span>
                                        <span class="input-group-addon" style="width: 50px;" onclick="$('#producto').val('BIFOCAL ');$('#producto').focus();"><span style="font-size:14px;"><font color='gray'>BIFOCAL</font></span>
                                        </span>
                                        <span class="input-group-addon" style="width: 50px;" onclick="$('#producto').val('MULTIFOCAL ');$('#producto').focus();"><span style="font-size:14px;"><font color='gray'>MULTIFOCAL</font></span>
                                        </span>
                                    </div>
									<!-- <input type="text" class="form-control" id="producto"> -->
                                    <textarea id="producto" class="form-control" rows="2" style='font-size:18px;'></textarea>
								</div>
							</div>
                            <br>
                            <div class="row">
                                <div class="col-lg-2"><label>Precio: </label> S/.</div>
                                <div class="col-lg-2"><input type="text" class="form-control" value=""  id="precio" placeholder="00.00"></div>
                            </div>
                            <br>
                            <div class="row">
                                <div class="col-lg-12">
                                    <div class="form-group">
                                        <label>Recomendaciones</label>
                                        <textarea class="form-control" id="recomendaciones" ></textarea>
                                    </div>
                                </div>
                            </div>
                            <br>
                            <div class="row">
                                <div class="col-lg-12">
                                    <div class="form-group">
                                        <label>Lugar de Registro</label>
                                        <select id="optica" class='form-control' style='font-size: 17px;'>
                                            <option value="Seleccione">Seleccione</option>
                                            <option value="INNOVA">ÓPTICA INNOVA</option>
                                            <option value="ZOOM PERU PUERTO">ÓPTICA ZOOM PERU PUERTO</option>
                                            <option value="ZOOM PERU PAMPA">ÓPTICA ZOOM PERU PAMPA</option>
                                        </select>
                                        <p class="help-block">En este campo debera seleccionar la optica en donde registro al Paciente</p>
                                    </div>
                                </div>
                            </div>
							<br>
							<div class="row">

								<div class="col-lg-1">
									<label>Fecha: </label>
								</div>
								<div class="col-lg-4">
									<input type="date" class="form-control" value="" id="timestamp_aux">
								</div>
							</div>
							<br>
                            <div class="row">
                                <div class="col-lg-12" align="center">
                                    <button type="button" class="btn btn-success btn-lg" id='btn_registrar' onclick="receta_register()">
                                    <img src="img/gif/loading2.gif" width="40" id='loading' style='display: none;'>
                                    Registrar Receta</button>
                                    <!-- <span class='button-actions'></span> -->
                                	<!-- <button type='button' class='btn btn-info btn-circle btn-x2'  data-toggle='modal' data-target='#modal_patientRecord' onclick="receta_getlistXpatient(27);" title='Ver historial del paciente'><i class='fa fa-list'></i></button> -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
    </div>
    <div class="modal fade" id="modal_patientRecord" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                    <h4 class="modal-title" id="myModalLabel">Historial de Recetas</h4>
                </div>
                <div class="modal-body">
                    <div id='bs_expediente'>
                        <div><b>Paciente: </b><span id='fullname'></span> - <span id='yearold'></span> años</div><br>
                        
                        <div id='btn_base_expediente' align="center"></div>
                        
                        <table class='table table-striped table-bordered' cellspacing="0" width="100%">
                            <tr>
                                <th colspan="5" align="center" style='text-align: center;'>HISTORIAL DE RECETAS DEL PACIETE</th>
                            </tr>
                            <tr>
                                <th>C.</th>
                                <th>Producto</th>
                                <th>Precio</th>
                                <th>Fecha</th>
                                <th></th>
                            </tr>
                            <tbody id='tb_getlistXpatient'></tbody>
                        </table>
                    </div>
                    <div id='bs_detailsRecipe'>

                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
    <script src="lib/sb-admin-2/vendor/jquery/jquery.min.js"></script>
    <script src="lib/sb-admin-2/vendor/bootstrap/js/bootstrap.min.js"></script>
    <script src="lib/sb-admin-2/vendor/metisMenu/metisMenu.min.js"></script>
    <script src="lib/sb-admin-2/dist/js/sb-admin-2.js"></script>
	
    <script src="js/luitor.js"></script>
    <script>
    $(document).ready(function() {
        var optica = '<%=session.optica%>';
        if(optica != 'null')
            $("#optica").val(optica);

        var comboplete1 = new Awesomplete('input.dropdown-input-esf-od', {
            minChars: 0
            ,autoFirst:true
            ,sort:false
        });
        Awesomplete.$('.dropdown-btn-esf-od').addEventListener("click", function() {
            if (comboplete1.ul.childNodes.length === 0) {
                comboplete1.minChars = 0;
                comboplete1.evaluate();
            }
            else if (comboplete1.ul.hasAttribute('hidden')) {
                comboplete1.open();
            }
            else {
                comboplete1.close();
            }
        });
        var comboplete2 = new Awesomplete('input.dropdown-input-cil-od', {
            minChars: 0
            ,autoFirst:true
            ,sort:false
        });
        Awesomplete.$('.dropdown-btn-cil-od').addEventListener("click", function() {
            if (comboplete2.ul.childNodes.length === 0) {
                comboplete2.minChars = 0;
                comboplete2.evaluate();
            }
            else if (comboplete2.ul.hasAttribute('hidden')) {
                comboplete2.open();
            }
            else {
                comboplete2.close();
            }
        });
        var comboplete3 = new Awesomplete('input.dropdown-input-esf-oi', {
            minChars: 0
            ,autoFirst:true
            ,sort:false
        });
        Awesomplete.$('.dropdown-btn-esf-oi').addEventListener("click", function() {
            if (comboplete3.ul.childNodes.length === 0) {
                comboplete3.minChars = 0;
                comboplete3.evaluate();
            }
            else if (comboplete3.ul.hasAttribute('hidden')) {
                comboplete3.open();
            }
            else {
                comboplete3.close();
            }
        });
        var comboplete4 = new Awesomplete('input.dropdown-input-cil-oi', {
            minChars: 0
            ,autoFirst:true
            ,sort:false
        });
        Awesomplete.$('.dropdown-btn-cil-oi').addEventListener("click", function() {
            if (comboplete4.ul.childNodes.length === 0) {
                comboplete4.minChars = 0;
                comboplete4.evaluate();
            }
            else if (comboplete4.ul.hasAttribute('hidden')) {
                comboplete4.open();
            }
            else {
                comboplete4.close();
            }
        });
        var comboplete5 = new Awesomplete('input.dropdown-input-add', {
            minChars: 0
            ,autoFirst:true
            ,sort:false
        });
        Awesomplete.$('.dropdown-btn-add').addEventListener("click", function() {
            if (comboplete5.ul.childNodes.length === 0) {
                comboplete5.minChars = 0;
                comboplete5.evaluate();
            }
            else if (comboplete5.ul.hasAttribute('hidden')) {
                comboplete5.open();
            }
            else {
                comboplete5.close();
            }
        });

        $("#esf_od").keyup(function(e) {
            if(this.value.length == 2 && e.keyCode != 8 )
                $(this).val( this.value +".");        
        });

        $("#cil_od").keyup(function(e) {
            if(this.value.length == 2 && e.keyCode != 8 )
                $(this).val( this.value +".");
        });
        $("#esf_oi").keyup(function(e) {
            if(this.value.length == 2 && e.keyCode != 8 )
                $(this).val( this.value +".");        
        });

        $("#cil_oi").keyup(function(e) {
            if(this.value.length == 2 && e.keyCode != 8 )
                $(this).val( this.value +".");
        });
        $("#add").keyup(function(e) {
            console.log("asa");
            if(this.value.length == 2 && e.keyCode != 8 )
                $(this).val( this.value +".");
        });
    });
        
    </script>
    <script>
        var recipes = [];
        var awesomplete;
        $(document).ready(function() {
            paciente_getlist();
            $("#timestamp_aux").val($l.getFechaStr(new Date()));
            <%if(idr!=0 && idp==0){%>
                $("#search_patient_row").hide(); 
                $("#cod_receta").show();
                //Preparando para actualizar
                receta_get();
                $("#btn_registrar").html("Actualizar");
                $("#btn_registrar").removeClass('btn-primary').addClass('btn-info');
            <%}else if(idp!=0){%>
                $("#search_patient_row").hide();
                paciente_get();
            <%}%>
        });
        function paciente_get(){

            $("#cod_receta").hide();
            $.post('/paciente_get', {
                idp: '<%=idp%>'
            }, function(dt, textStatus, xhr) {
                $("#id_receta").val("");
                $("#id_paciente").val(dt[0].id_paciente);
                $("#fullname").val(dt[0].fullname);
                $("#edad").val(dt[0].yearold);
            });
        }
        function receta_get(){
            $.post('/receta_get', {
                idr: '<%=idr%>'
            }, function(dt, textStatus, xhr) {
                console.log(dt[0]);
                $("#esf_od").val(dt[0].esf_od);
                $("#esf_oi").val(dt[0].esf_oi);
                $("#cil_od").val(dt[0].cil_od);
                $("#cil_oi").val(dt[0].cil_oi);
                $("#eje_od").val(dt[0].eje_od);
                $("#eje_oi").val(dt[0].eje_oi);
                $("#add").val(dt[0].add);
                $("#dip1").val(dt[0].dip1);
                $("#dip2").val(dt[0].dip2);
                $("#edad").val(dt[0].edad);
                $("#recomendaciones").val(dt[0].recomendaciones);
                $("#producto").val(dt[0].producto);
                $("#precio").val(dt[0].precio);
                $("#timestamp_aux").val(dt[0].timestamp_aux.split("T")[0]);
                $("#id_paciente").html(dt[0].id_paciente);
                $("#fullname").val(dt[0].fullname);
                $("#optica").val(dt[0].optica);

            });
        }
        var r_r = true;
        function receta_register(){
            if(r_r){ //Presionado 1 ves
                r_r = false; //desactivamos buttom
                var obj_in = {
                    id_receta: $("#id_receta").val()
                    ,esf_od: $("#esf_od").val()
                    ,esf_oi: $("#esf_oi").val()
                    ,cil_od: $("#cil_od").val()
                    ,cil_oi: $("#cil_oi").val()
                    ,eje_od: $("#eje_od").val()
                    ,eje_oi: $("#eje_oi").val()
                    // ,prisma_od: $("#prisma_od").val()
                    // ,prisma_oi: $("#prisma_oi").val()
                    // ,av_od: $("#av_od").val()
                    // ,av_oi: $("#av_oi").val()
                    ,add: $("#add").val()
                    ,dip1: $("#dip1").val()
                    ,dip2: $("#dip2").val()
                    ,edad: $("#edad").val()
                    ,recomendaciones: $("#recomendaciones").val()
                    ,producto: $("#producto").val().toUpperCase()
                    ,precio: $("#precio").val()==""?0.00:$("#precio").val()
                    ,timestamp_aux: $("#timestamp_aux").val()
                    ,id_paciente: $("#id_paciente").html()
                    ,fullname: $("#fullname").val().toUpperCase()
                    ,optica: $("#optica").val()
                }
                var err = verify(obj_in);
                console.log("Error: "+err);
                if(err){
                    $("#loading").hide();
                    return;
                }
                // alert($("#optica").val());
                console.log("enviando al servidor");
                // return;
                $.post('/receta_register', obj_in, function(id_receta, textStatus, xhr) {
                    $("#loading").hide();
                    if(id_receta){
                        clearInputs();
                        window.location.href='admin_patientRecord?idp='+obj_in.id_paciente;
                        
                    }
                    r_r = true; //activamos button
                });
            }
        }
        function verify(obj_in){
            console.log("-------------------------------------------------");
            console.log("Resultado de verificación");
            var err = false;
            var med = false;
            for(i in obj_in){
                $("#"+i).css('background','');
                //Verificación de Campos vacios
                if(obj_in[i] == null || obj_in[i] == "" || obj_in[i] == 0 || obj_in[i] == 'Seleccione' ){

                    

                    //exeptions - No obigatorios
                    if( i == 'recomendaciones' || i=='producto' 
                        || i=='esf_od' || i=='cil_od' || i=='esf_oi' || i=='cil_oi' 
                        || i=='id_receta' || i=='eje_od' || i=='eje_oi'
                        || i=='add' || i=='dip2' || i=='edad' || i=='timestamp_aux' || i=='precio' )
                        continue;
                    console.log("[*obligatorio]>> "+i);
                    err =true;
                    $("#"+i).css('background','#FFDEDE').focus();
                }
            }
            console.log("err: "+err);
            //Medida -- Si todos las medidas estan en blanco, automaticamente se ponen en 0.00
            if(err)
                return err;
            if( $("#eje_od").val() != "" || $("#cil_od").val() != "" ){
                err=true;
                //par completado
                if( $("#eje_od").val() != "" && $("#cil_od").val() != "" )
                    err=false;
                if($("#eje_od").val() == "")
                    $("#eje_od").css("background","#F7B2B2").focus();
                if($("#cil_od").val() == "")
                    $("#cil_od").css("background","#F7B2B2").focus();
            }
            if(err)
                return err;
            if( $("#eje_oi").val() != "" || $("#cil_oi").val() != "" ){
                err=true;
                //par completado
                if( $("#eje_oi").val() != "" && $("#cil_oi").val() != "" )
                    err=false;
                if($("#eje_oi").val() == "")    
                    $("#eje_oi").css("background","#F7B2B2").focus();
                if($("#cil_oi").val() == "")
                    $("#cil_oi").css("background","#F7B2B2").focus();
            }
            return err;
        }
        function clearInputs(){
            $("input,textarea").val("");
            $("#timestamp_aux").val($l.getFechaStr(new Date()));
        }
        var listAll = [];
        var patients = [];
        function paciente_getlist(){
            $.post('/paciente_getlist', {
            }, function(dt, textStatus, xhr) {
                var input = document.getElementById("search_patient");
                awesomplete = new Awesomplete(input);
                for(i in dt){
                    listAll.push(dt[i].fullname+" [Cod:"+dt[i].id_paciente+"]");
                    patients[dt[i].id_paciente] = dt[i];
                }
                awesomplete.list = listAll;
                awesomplete.autoFirst = true;
            });
        }
        function awesomplete_select(){
            try{
                var item = $("#search_patient").val();
                var arr = item.split(" [Cod:");
                var fullname = arr[0];
                var idp = arr[1].split("]")[0];
                $("#id_paciente").html(idp);
                $("#fullname").val(fullname);
                $("#edad").val(patients[idp].yearold);
                $(".button-actions").html(
                    "<a target='_blank' class='btn btn-primary btn-mx' style='' role='button' onclick='receta_getlistXpatient("+idp+")' data-toggle='modal' data-target='#modal_patientRecord' >Ver ultimas recetas</a>"
                );
            }catch(ex){
                console.log(ex);
            }
            

            // console.log(fullname+" "+idp);
        }
 
        function receta_getlistXpatient(id_paciente){
            $.post('/receta_getlistXpatient', {
                id_paciente: id_paciente
            }, function(dt, textStatus, xhr) {
                $("#btn_base_expediente").html(
                    "<a href='admin_patientRecord?idp="+id_paciente+"' target='_blank' class='btn btn-warning btn-xs'>Ir a Expediente del Paciente</a><br><br>"
                );
                // console.log(patients[id_paciente]);
                var patient = patients[id_paciente];
                // console.log(patient.fullname);
                var bs_expediente = $("#bs_expediente");
                bs_expediente.find("#fullname").html(patient.fullname.toUpperCase());
                bs_expediente.find("#yearold").html(patient.yearold);
                bs_expediente.find("#datetime").html(": "+patient.datetime.split("T")[0]);
                bs_expediente.find("#telephone").html(": "+patient.telephone);
                bs_expediente.find("#optica").html(": Óptica "+patient.optica);

                var dh = "";
                for(i in dt){
                    recipes[dt[i].id_receta] = dt[i];
                    dh+= "<tr id='recipe_"+dt[i].id_receta+"'>"
                            +"<td>"+dt[i].id_receta+"</td>"
                            +"<td>"+dt[i].producto+"</td>"
                            +"<td>"+dt[i].precio+"</td>"
                            +"<td>"+dt[i].timestamp_aux.split("T")[0]+"</td>"
                            +"<td align='center'>"
                            +"<button type='button' class='btn btn-info btn-circle btn-x2'  data-toggle='modal' data-target='#modal_patientRecipe' onclick=\"view_detailsRecipe("+dt[i].id_receta+");$('#bs_expediente').hide();$('#bs_detailsRecipe').show();\"><i class='fa fa-search'></i></button>"
                            +"</td>"
                            
                        +"</tr>";
                }
                    
                $("#tb_getlistXpatient").html(dh);
            });
        }
        function view_detailsRecipe(idp){
            var dt = recipes[idp];
            console.log(dt);
            var dh = ""
                    +"<table class='' width='100%' border='0' bordercolor='#D1D1D1'>"
                        +"<tr>"
                            +"<td><button class='btn btn-social-icon btn-bitbucket' onclick=\"$('#bs_detailsRecipe').hide();$('#bs_expediente').show();\"><i class='fa fa-mail-reply'></i></button></td>"
                            +"<td align='right' style='color:#3347AE;'>Óptica "+dt.optica+", "+dt.timestamp_aux.split("T")[0]+"</td>"
                        +"</tr>"
                    +"</table><br>"
                    +"<table class='table' border='1' bordercolor='#D1D1D1'>"
                        +"<tr>"
                            +"<th class='cell_header' colspan='6'>Receta[#31]: "+dt.fullname+"</th>"
                        +"</tr>"
                        +"<tr>"
                            +"<td></td>"
                            +"<th class='cell_header'>Esf.</th>"
                            +"<th class='cell_header'>Cil.</th>"
                            +"<th class='cell_header'>Eje.</th>"
                        +"</tr>"
                        +"<tr>"
                            +"<th class='cell_header'>OD.</th>"
                            +"<td style='font-size:17px;'>"+dt.esf_od+"</td>"
                            +"<td style='font-size:17px;'>"+dt.cil_od+"</td>"
                            +"<td style='font-size:17px;'>"+dt.eje_od+"</td>"
                        +"</tr>"
                        +"<tr>"
                            +"<th class='cell_header'>OI.</th>"
                            +"<td style='font-size:17px;'>"+dt.esf_oi+"</td>"
                            +"<td style='font-size:17px;'>"+dt.cil_oi+"</td>"
                            +"<td style='font-size:17px;'>"+dt.eje_oi+"</td>"
                        +"</tr>"
                    +"</table>"
                    +"<table class='table' border='1' bordercolor='#D1D1D1'>"
                        +"<tr>"
                            +"<th class='cell_header'>ADD</th>"
                            +"<th colspan='2' class='cell_header'>DIP</th>"
                            +"<th class='cell_header'>EDAD</th>"
                        +"</tr>"
                        +"<tr>"
                            +"<td style='font-size:17px;'>"+dt.add+"</td>"
                            +"<td style='font-size:17px;'>"+dt.dip1+"</td>"
                            +"<td style='font-size:17px;'>"+dt.dip2+"</td>"
                            +"<td style='font-size:17px;'>"+dt.edad+"</td>"
                        +"</tr>"
                    +"</table>"
                    +"<table class='table' border='1' bordercolor='#D1D1D1'>"
                        +"<tr>"
                            +"<th class='cell_header'>Producto</th>"
                            +"<th class='cell_header'>Precio</th>"
                        +"</tr>"
                        +"<tr>"
                            +"<td style='font-size:16px;'>"+dt.producto+"</td>"
                            +"<td style='font-size:17px;'>"+dt.precio+"</td>"
                        +"</tr>"
                        +"<tr>"
                            +"<th colspan='2' class='cell_header'>Recomendaciones</th>"
                        +"</tr>"
                        +"<tr>"
                            +"<td colspan='2'>"+dt.recomendaciones+"</td>"
                        +"</tr>"
                    +"</table>"
            ;
            $("#bs_detailsRecipe").html(dh);
        }
    </script>
    </body>
</html>
